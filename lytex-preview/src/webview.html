<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LyTeX Preview</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            color: var(--vscode-foreground);
            background: var(--vscode-editor-background);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: var(--vscode-panel-background);
            padding: 8px 12px;
            border-bottom: 1px solid var(--vscode-panel-border);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .placeholder {
            text-align: center;
            padding: 20px;
        }
        
        .error { color: var(--vscode-errorForeground); }
        .loading { color: var(--vscode-charts-orange); }
        
        .pdf-container {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        
        .controls {
            background: var(--vscode-panel-background);
            padding: 4px 8px;
            border-bottom: 1px solid var(--vscode-panel-border);
            font-size: 12px;
        }
        
        .controls button, .controls input {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 2px 6px;
            margin: 0 2px;
            cursor: pointer;
        }
        
        .controls button:hover {
            background: var(--vscode-button-hoverBackground);
        }
        
        .controls input {
            width: 40px;
            text-align: center;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
        }
        
        .viewer {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 10px;
            background: #525659;
        }
        
        canvas {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
    <!-- Load PDF.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <header>
        <div>LyTeX Preview:  <span id="filename">{{FILENAME}}</span></div>
        <div id="status">Initializing...</div>
    </header>
    
    <main>
        <div class="placeholder" id="placeholder">
            <h3>LyTeX Preview</h3>
            <p id="message">Compiling your LilyPond + LaTeX document...</p>
        </div>
        
        <div class="pdf-container" id="pdf-container">
            <div class="controls">
                <button id="prev-page">‹</button>
                <input type="number" id="page-num" value="1" min="1">
                / <span id="page-count">--</span>
                <button id="next-page">›</button>
                <button id="zoom-out">−</button>
                <span id="zoom-level">160%</span>
                <button id="zoom-in">+</button>
            </div>
            <div class="viewer">
                <canvas id="pdf-canvas"></canvas>
            </div>
        </div>
    </main>
    
    <script>
        // ==============================================
        // PDF.js Configuration & Global Variables
        // ==============================================
        console.log('LyTeX Preview webview loaded');
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // DOM Elements
        const elements = {
            status: document.getElementById('status'),
            message: document.getElementById('message'),
            placeholder: document.getElementById('placeholder'),
            pdfContainer: document.getElementById('pdf-container'),
            canvas: document.getElementById('pdf-canvas'),
            pageNum: document.getElementById('page-num'),
            pageCount: document.getElementById('page-count'),
            zoomLevel: document.getElementById('zoom-level')
        };
        
        // PDF State
        const pdfState = {
            doc: null,
            pageNum: 1,
            pageRendering: false,
            pageNumPending: null,
            scale: 1.6
        };
        
        const ctx = elements.canvas.getContext('2d');
        
        // ==============================================
        // UI Control Functions
        // ==============================================
        function showPlaceholder(message, className = '') {
            elements.placeholder.style.display = 'block';
            elements.pdfContainer.style.display = 'none';
            elements.message.textContent = message;
            elements.message.className = className;
        }
        
        function showPDF() {
            elements.placeholder.style.display = 'none';
            elements.pdfContainer.style.display = 'flex';
        }
        
        function updateZoomDisplay() {
            elements.zoomLevel.textContent = Math.round(pdfState.scale * 100) + '%';
        }
        
        // ==============================================
        // PDF Rendering Functions
        // ==============================================
        function renderPage(num) {
            pdfState.pageRendering = true;
            
            pdfState.doc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale: pdfState.scale });
                elements.canvas.height = viewport.height;
                elements.canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                page.render(renderContext).promise.then(() => {
                    pdfState.pageRendering = false;
                    if (pdfState.pageNumPending !== null) {
                        renderPage(pdfState.pageNumPending);
                        pdfState.pageNumPending = null;
                    }
                });
            });
            
            elements.pageNum.value = num;
        }
        
        function queueRenderPage(num) {
            if (pdfState.pageRendering) {
                pdfState.pageNumPending = num;
            } else {
                renderPage(num);
            }
        }
        
        function loadPDF(base64Data) {
            console.log('Loading PDF from base64 data...');
            
            const pdfData = 'data:application/pdf;base64,' + base64Data;
            
            pdfjsLib.getDocument(pdfData).promise
                .then(pdf => {
                    pdfState.doc = pdf;
                    elements.pageCount.textContent = pdf.numPages;
                    
                    console.log('PDF loaded successfully, pages:', pdf.numPages);
                    showPDF();
                    renderPage(pdfState.pageNum);
                })
                .catch(error => {
                    console.error('Error loading PDF:', error);
                    showPlaceholder('Error loading PDF: ' + error.message, 'error');
                });
        }
        
        // ==============================================
        // Event Handlers
        // ==============================================
        function setupPDFControls() {
            // Navigation
            document.getElementById('prev-page').addEventListener('click', () => {
                if (pdfState.pageNum <= 1) return;
                pdfState.pageNum--;
                queueRenderPage(pdfState.pageNum);
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                if (pdfState.pageNum >= pdfState.doc.numPages) return;
                pdfState.pageNum++;
                queueRenderPage(pdfState.pageNum);
            });
            
            // Zoom
            document.getElementById('zoom-in').addEventListener('click', () => {
                pdfState.scale += 0.2;
                updateZoomDisplay();
                queueRenderPage(pdfState.pageNum);
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                if (pdfState.scale <= 0.4) return;
                pdfState.scale -= 0.2;
                updateZoomDisplay();
                queueRenderPage(pdfState.pageNum);
            });
            
            // Page input
            elements.pageNum.addEventListener('change', function() {
                const num = parseInt(this.value);
                if (num >= 1 && num <= pdfState.doc.numPages) {
                    pdfState.pageNum = num;
                    queueRenderPage(pdfState.pageNum);
                }
            });
        }
        
        function handleExtensionMessage(message) {
            console.log('Received message:', message);
            
            switch (message.command) {
                case 'compile':
                    elements.status.textContent = 'Compiling...';
                    showPlaceholder('Compiling your LilyPond + LaTeX document...', 'loading');
                    break;
                    
                case 'compiled':
                    elements.status.textContent = 'Compilation complete';
                    if (message.pdfData) {
                        loadPDF(message.pdfData);
                    } else {
                        showPlaceholder('No PDF data received', 'error');
                    }
                    break;
                    
                case 'error':
                    elements.status.textContent = 'Compilation failed';
                    showPlaceholder(message.error || 'Compilation failed', 'error');
                    break;
                    
                case 'ready':
                    elements.status.textContent = 'Ready';
                    break;
                    
                default:
                    console.log('Unknown command:', message.command);
            }
        }
        
        // ==============================================
        // Initialization
        // ==============================================
        window.addEventListener('message', event => handleExtensionMessage(event.data));
        setupPDFControls();
        updateZoomDisplay();
        showPlaceholder('Waiting for compilation...');
    </script>
</body>
</html>
